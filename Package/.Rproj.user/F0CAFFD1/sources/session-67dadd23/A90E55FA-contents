library(MiXcan)
library(tidyverse)
library(doParallel)
nCores=detectCores()-1; registerDoParallel(nCores) # use parallel computing for speed

# # my try out data; you can use it to try out or ignore it. 
# set.seed(123)
# data(example_data)
# x=x_example
# y=y_example
# cov=cov_example
# yName="Gene1"
# pi <- pi_estimation(expression_matrix = GTEx_epithelial_genes,
#                     prior = GTEx_prior,
#                     n_iteration = 5)$mean_trim_0.05


# MiXcan ensemble function ----------
# You input B = No. of models for ensemble
# You input seed= umbrella seed

# You get output vote = fraction from consensus vote 
# You get output ensemble_weight = ensemble weights by model "type" (NP, NS, CTS).  

MiXcan_ensemble=function(y, x, cov, pi, yName=NULL, B=10, seed=NULL) {
  
  # start foreach 
  res=foreach(i = 1:B, .combine=rbind) %dopar% {
    print(i)
    # set seed 
    if (is.null(seed)==F) {set.seed(seed+i*123);
      foldid1 <- sample(1:10, length(y), replace=T)
    } else {foldid1=NULL}
    # run MiXcan
    model <- MiXcan(y=y, x=x, cov = cov,
                            pi= pi,
                            foldid = foldid1, yName=yName)
    
    # Refit
    MiXcan_weight_refit <- MiXcan_refit_weight(model = model,
                                               y=y,
                                               x=x, cov = cov,
                                               pi= pi, keepZeroWeight=T)

    return(cbind(ID=i, MiXcan_weight_refit))
  }
  
  # summary B results
  sum=unique(res[,c("ID", "type")])
  vote=c(CellTypeSpecific=mean(sum$type=="CellTypeSpecific"), 
         NonSpecific=mean(sum$type=="NonSpecific"), 
         NoPredictor=mean(sum$type=="NoPredictor"))
  
  ensemble_weight= res %>% group_by(type, xNameMatrix) %>%
    summarise_at(vars("weight_cell_1", "weight_cell_2"), mean) %>%
    filter(weight_cell_1!=0 |weight_cell_2 !=0)

  return(list(vote=vote, ensemble_weight=ensemble_weight))

}

# use MiXcan_ensemble function --------------

data(example_data)
pi_example <- pi_estimation(expression_matrix = GTEx_epithelial_genes,
                    prior = GTEx_prior,
                    n_iteration = 5)$mean_trim_0.05

ensbl=MiXcan_ensemble(y=y_example, x=x_example, cov = cov_example,
                      pi= pi_example, yName="Gene1", B=11, seed=123)

# You get output vote = fraction from consensus vote 
ensbl$vote
# CellTypeSpecific      NonSpecific      NoPredictor 
# 0                1                0 
# You get output ensemble_weight, which are the weights by model 
# "type" (NP, NS, CTS).  
ensbl$ensemble_weight

# type        xNameMatrix weight_cell_1 weight_cell_2
# <chr>       <chr>               <dbl>         <dbl>
# 1 NonSpecific SNP10             -0.0244       -0.0244
# 2 NonSpecific SNP18              0.0555        0.0555
# 3 NonSpecific SNP19             -0.126        -0.126 
# 4 NonSpecific SNP3               0.0741        0.0741
# 5 NonSpecific SNP4               0.0690        0.0690
# 6 NonSpecific SNP9              -0.0324       -0.0324






